<script type="text/javascript">
var globalChannel = 27;
var page = 1,pagesize = 20,load = 1,channel = '<%= @channel %>',sort = 0,is_simple = true, sort_type='',is_t = false, is_h = false, is_q = false, keyword = '<%= @keyword %>';
var path = 'http://api.uuhaodian.com/uu/dg_goods_list';
function createList_dg(cl){
  var obj = $('#dazheList');
  var htmlstr = '';
  for(var i=0,len=cl.length;i<len;i++){
    var z = cl[i];
    var coupon_money = z.coupon_amount ? parseInt(z.coupon_amount) : 0;
    var now_price = (parseFloat(z.zk_final_price) - coupon_money).toFixed(2);
    var o_price = coupon_money > 0 ? parseFloat(z.zk_final_price).toFixed(2) : parseFloat(z.reserve_price).toFixed(2);
    var zhe = (now_price * 10.0 / o_price).toFixed(1);
    var buy_url = 'http://api.uuhaodian.com/uu/buy?id=' + z.item_id + '&channel=' + channel;
    htmlstr += '<div class="item">';
    htmlstr += '<a class = "zh" href="'+ buy_url +'" target="_blank">';
    htmlstr += '<img class="pic" src="'+ z.pict_url +'" alt="'+z.
      title +'"/>';
    htmlstr += '<div class="cent">';
    if(z.short_title != ''){
      htmlstr += '<h3>'+ z.short_title + '</h3>';
    }
    else{
      htmlstr += '<h3>'+ z.title + '</h3>';
    }
    htmlstr += '<div class="num">';
    htmlstr += '<span>原价 ￥'+ o_price + '</span>';
    htmlstr += '<span class="r">已售'+ z.volume + '件</span></div>';
    if(coupon_money > 0){
      htmlstr += '<div class="money"><div class="quan"><i>' + coupon_money + '元券</i></div>';
    }
    else{
      htmlstr += '<div class="money"><div class="quan"><i>' + zhe + ' 折</i></div>';
    }
    htmlstr += '到手价 ￥'
    htmlstr += '<span class="m">' + now_price + '</span></div>'
    htmlstr += '</div></a></div>';
  }
  htmlstr = $(htmlstr);
  obj.append(htmlstr);
}
function createList_1(cl, obj){
  var htmlstr = '';
  for(var i=0,len=cl.length;i<len;i++){
    var z = cl[i];
    var re = /activityId=(\w*)/;
    var buy_url = '/yh/' + z.itemId + '/?coupon_money=' + z.couponMoney + '#coupon';
    htmlstr += '<div class="item">';
    htmlstr += '<a class = "zh" href="'+ buy_url +'" target="_blank">';
    htmlstr += '<img class="pic" src="'+ z.coverImage +'" alt="'+z.
      title +'"/>';
    htmlstr += '<div class="cent">';
    htmlstr += '<h3>'+ z.shortTitle + '</h3>';
    htmlstr += '<div class="num">';
    htmlstr += '<span>原价 ￥'+ z.price + '</span>';
    htmlstr += '<span class="r">已售'+ z.monthSales + '件</span></div>';
    htmlstr += '<div class="money"><div class="quan"><i>' + parseInt(z.couponMoney) + '元券</i></div>';
    htmlstr += '券后价 ￥'
    htmlstr += '<span class="m">' + z.nowPrice + '</span></div>'
    htmlstr += '</div></a></div>';
  }
  htmlstr = $(htmlstr);
  obj.append(htmlstr);
}
function createList_2(cl, obj){
  var htmlstr = '';
  for(var i=0,len=cl.length;i<len;i++){
    var z = cl[i];
    var re = /减(\d+)元/;
    var coupon_money = parseInt(re.exec(z.coupon_info)[1]);
    var buy_url = '/yh/' + z.num_iid + '/?coupon_money=' + coupon_money + '#coupon';
    htmlstr += '<div class="item">';
    htmlstr += '<a class = "zh" href="'+ buy_url +'" target="_blank">';
    htmlstr += '<img class="pic" src="'+ z.pict_url +'" alt="'+z.
      title +'"/>';
    htmlstr += '<div class="cent">';
    htmlstr += '<h3>'+ z.title + '</h3>';
    htmlstr += '<div class="num">';
    htmlstr += '<span>天猫价 ￥'+ z.zk_final_price + '</span>';
    htmlstr += '<span class="r">已售'+ z.volume + '件</span></div>';
    htmlstr += '<div class="money"><div class="quan"><i>' + coupon_money + '元券</i></div>';
    htmlstr += '券后价 ￥'
    htmlstr += '<span class="m">' + (z.zk_final_price - coupon_money).toFixed(2) + '</span></div>'
    htmlstr += '</div></a></div>';
  }
  htmlstr = $(htmlstr);
  obj.append(htmlstr);
}
function createList_3(cl, obj){
  var htmlstr = '';
  for(var i=0,len=cl.length;i<len;i++){
    var z = cl[i];
    var buy_url = z.item_url;
    htmlstr += '<div class="item">';
    htmlstr += '<a class = "zh" href="'+ buy_url +'" target="_blank" isconvert=1>';
    htmlstr += '<img class="pic" src="'+ z.pict_url +'" alt="'+z.
      title +'"/>';
    htmlstr += '<div class="cent">';
    htmlstr += '<h3>'+ z.title + '</h3>';
    htmlstr += '<div class="num">';
    htmlstr += '<span>天猫价 ￥'+ z.reserve_price + '</span>';
    htmlstr += '<span class="r">已售'+ z.volume + '件</span></div>';
    htmlstr += '<div class="money"><div class="quan"><i>' + (parseFloat(z.zk_final_price) * 10.0 / parseFloat(z.reserve_price)).toFixed(1) + ' 折</i></div>';
    htmlstr += '折扣价 ￥'
    htmlstr += '<span class="m">' + z.zk_final_price + '</span></div>'
    htmlstr += '</div></a></div>';
  }
  htmlstr = $(htmlstr);
  obj.append(htmlstr);
}
function getDazheCouponList(){
  if(!load){
    return;
  }
  alert("start ajax");
  var dd = {
    'keyword': keyword,
    'sort': sort_type,
    'page':page,
    'callback': 'callback'
  };
  if(is_simple){
    dd.is_simple = 1
  }
  if(is_t){
    dd.is_tmall = 1
  }
  if(is_h){
    dd.is_overseas = 1
  }
  if(is_q){
    dd.has_coupon = 1
  }
  $.ajax({
    url: path,
    type: 'GET',
    dataType: 'jsonp',
    data: dd,
    beforeSend:function(){
      load = 0;
    },
    success:function(data){
    }
  });
}
var callback = function(data){
  load = 1;
  page ++;
  alert("callback " + data.status);
  if(data.status == 1){
    createList_dg(data.results);
  }
};

$(function(){
  getDazheCouponList();
  $(document).scroll(function(){
    tp = document.body.scrollTop || document.documentElement.scrollTop;
    if(tp > 200){
      $('.scroll_top').removeClass('close');
      $('.scroll_top').addClass('open');
      $('.filter').addClass('fixed');
    }
    else{
      $('.scroll_top').removeClass('open');
      $('.scroll_top').addClass('close');
      $('.filter').removeClass('fixed');
    }
    if(tp >= (document.body.scrollHeight - 800)){
      _hmt.push(['_trackEvent', '加载更多', 'click', 'dazhe']);
      getDazheCouponList();
    }
  });
  $(".scroll_top>a").click(function(){window.scrollTo(0, 2);});
  $(".type").click(function(){
    var _this = $(this);
    if(_this.data('sort') == '3'){
      if(!_this.hasClass('active')){
        $('.type.active').removeClass('active');
        _this.addClass('active');
        is_simple = false;
        sort_type = "price_asc";
        $("#t3").html("价格↑");
      }
      else{
        if(sort_type == "price_asc"){
          sort_type = "price_des"
          $("#t3").html("价格↓");
        }else{
          sort_type = "price_asc"
          $("#t3").html("价格↑");
        }
      }
      page = 1;
      $("#dazheList").html("");
      getDazheCouponList();
      return;
    }
    if(!_this.hasClass('active')){
      $('.type.active').removeClass('active');
      _this.addClass('active');
      sort = _this.data('sort');
      if(sort == '7'){
        is_simple = true;
        $("#t3").html("价格");
      }
      else if (sort == '1'){
        is_simple = false;
        sort_type = "tk_rate_des"
        $("#t3").html("价格");
      }
      else if (sort == '4'){
        is_simple = false;
        sort_type = "total_sales_des";
        $("#t3").html("价格");
      }
    }
    page = 1;
    $("#dazheList").html("");
    getDazheCouponList();
  });
});
</script>
